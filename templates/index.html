<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segment Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .pcb-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pcb-title {
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }
        .displays-container {
            display: flex;
            gap: 35px;
            justify-content: center;
            align-items: center;
        }
        .display-group {
            text-align: center;
        }
        .display-title {
            font-size: 0.8em;
            margin-bottom: 5px;
            color: #666;
        }
        .controls {
            margin-bottom: 30px;
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 8px 16px;
            margin: 0 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: all 0.2s;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #000;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .preset-controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .save-preset, .load-preset {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .preset-input, .preset-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
            min-width: 200px;
        }
        .preset-input:focus, .preset-select:focus {
            outline: none;
            border-color: #007bff;
        }
        .seven-segment {
            width: 60px;
            height: 100px;
            display: inline-block;
            margin: 15px;
            background: transparent;
        }
        .segment {
            fill: #f4f4f4;
            transition: fill 0.15s;
            cursor: pointer;
        }
        .segment:hover {
            fill: #e8e8e8;
        }
        .segment.on {
            fill: #ff0000;
        }
        .dp {
            fill: #f4f4f4;
            cursor: pointer;
            transition: fill 0.15s;
        }
        .dp:hover {
            fill: #e8e8e8;
        }
        .dp.on {
            fill: #ff0000;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button id="clearAllBtn" class="btn btn-danger">Clear All</button>
        <button id="hoverToggleBtn" class="btn">Enable Hover</button>
        
        <!-- Preset Controls -->
        <div class="preset-controls">
            <div class="save-preset">
                <input type="text" id="presetName" placeholder="Preset name" class="preset-input">
                <button id="savePresetBtn" class="btn btn-primary">Save Preset</button>
            </div>
            <div class="load-preset">
                <select id="presetSelect" class="preset-select">
                    <option value="">Select a preset...</option>
                    {% for preset in presets %}
                        <option value="{{ preset }}">{{ preset }}</option>
                    {% endfor %}
                </select>
                <button id="loadPresetBtn" class="btn btn-success">Load</button>
                <button id="deletePresetBtn" class="btn btn-warning">Delete</button>
            </div>
        </div>
    </div>

    <div class="grid-container">
        {% set pcb_layout = [
            [1, 6, 11],
            [2, 7, 12],
            [3, 8, 13],
            [4, 9, 14],
            [5, 10, 15]
        ] %}
        
        {% for row in pcb_layout %}
            {% for pcb in row %}
                <div class="pcb-container">
                    <div class="pcb-title">PCB {{ pcb }}</div>
                    <div class="displays-container">
                        {% set display_segments = [
                            [(0, 'A'), (1, 'B'), (2, 'C'), (3, 'D'), (4, 'E'), (5, 'F'), (6, 'G'), (7, 'DP')],
                            [(16, 'A'), (17, 'B'), (18, 'C'), (19, 'D'), (20, 'E'), (21, 'F'), (22, 'G'), (23, 'DP')],
                            [(8, 'A'), (9, 'B'), (10, 'C'), (11, 'D'), (12, 'E'), (13, 'F'), (14, 'G'), (15, 'DP')]
                        ] %}
                        
                        {% for display_index in range(3) %}
                            <div class="display-group">
                                <div class="display-title">Display {{ display_index + 1 }}</div>
                                <svg class="seven-segment" viewBox="0 0 120 200">
                                    <!-- Segment A (top horizontal) -->
                                    <path 
                                        class="segment" 
                                        data-pcb="{{ pcb - 1 }}" 
                                        data-segment="{{ display_segments[display_index][0][0] }}"
                                        d="M30 20L90 20L80 35L40 35L30 20"
                                    />
                                    
                                    <!-- Segment B (top right vertical) -->
                                    <path 
                                        class="segment"
                                        data-pcb="{{ pcb - 1 }}"
                                        data-segment="{{ display_segments[display_index][1][0] }}"
                                        d="M95 25L110 40L110 80L95 95L80 80L80 40L95 25"
                                    />
                                    
                                    <!-- Segment C (bottom right vertical) -->
                                    <path 
                                        class="segment"
                                        data-pcb="{{ pcb - 1 }}"
                                        data-segment="{{ display_segments[display_index][2][0] }}"
                                        d="M95 105L110 120L110 160L95 175L80 160L80 120L95 105"
                                    />
                                    
                                    <!-- Segment D (bottom horizontal) -->
                                    <path 
                                        class="segment"
                                        data-pcb="{{ pcb - 1 }}"
                                        data-segment="{{ display_segments[display_index][3][0] }}"
                                        d="M30 180L90 180L80 165L40 165L30 180"
                                    />
                                    
                                    <!-- Segment E (bottom left vertical) -->
                                    <path 
                                        class="segment"
                                        data-pcb="{{ pcb - 1 }}"
                                        data-segment="{{ display_segments[display_index][4][0] }}"
                                        d="M25 105L40 120L40 160L25 175L10 160L10 120L25 105"
                                    />
                                    
                                    <!-- Segment F (top left vertical) -->
                                    <path 
                                        class="segment"
                                        data-pcb="{{ pcb - 1 }}"
                                        data-segment="{{ display_segments[display_index][5][0] }}"
                                        d="M25 25L40 40L40 80L25 95L10 80L10 40L25 25"
                                    />
                                    
                                    <!-- Segment G (middle horizontal) -->
                                    <path 
                                        class="segment"
                                        data-pcb="{{ pcb - 1 }}"
                                        data-segment="{{ display_segments[display_index][6][0] }}"
                                        d="M30 100L40 90L80 90L90 100L80 110L40 110L30 100"
                                    />
                                    
                                    <!-- Decimal Point -->
                                    <circle 
                                        class="dp"
                                        data-pcb="{{ pcb - 1 }}"
                                        data-segment="{{ display_segments[display_index][7][0] }}"
                                        cx="105" 
                                        cy="180" 
                                        r="8"
                                    />
                                </svg>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% endfor %}
    </div>

    <script>
        var hoverEnabled = false;

        // Existing toggle functionality
        $("#clearAllBtn").click(function() {
            $.post('/clear_all', {}, function(response) {
                if (response.success) {
                    $(".segment, .dp").removeClass('on');
                }
            });
        });

        $("#hoverToggleBtn").click(function() {
            hoverEnabled = !hoverEnabled;
            $(this).text(hoverEnabled ? 'Disable Hover' : 'Enable Hover');
            $(this).toggleClass('active');
        });

        $(".segment, .dp").click(function() {
            if (!hoverEnabled) {
                toggleSegment($(this));
            }
        });

        $(".segment, .dp").hover(debounce(function() {
            if (hoverEnabled) {
                toggleSegment($(this));
            }
        }, 50), function() {});

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function toggleSegment(segmentElement) {
            var pcb = segmentElement.data('pcb');
            var segment = segmentElement.data('segment');
            $.post('/toggle_segment', { pcb: pcb, segment: segment }, function(response) {
                if (response.success) {
                    segmentElement.toggleClass('on');
                }
            });
        }

        // New preset management functionality
        $("#savePresetBtn").click(function() {
            const name = $("#presetName").val().trim();
            if (!name) {
                alert("Please enter a preset name");
                return;
            }

            $.post('/save_preset', { name: name }, function(response) {
                if (response.success) {
                    // Update preset dropdown
                    updatePresetDropdown(response.presets);
                    $("#presetName").val('');
                    alert("Preset saved successfully!");
                } else {
                    alert("Error saving preset: " + response.error);
                }
            });
        });

        $("#loadPresetBtn").click(function() {
            const name = $("#presetSelect").val();
            if (!name) {
                alert("Please select a preset");
                return;
            }

            $.post('/load_preset', { name: name }, function(response) {
                if (response.success) {
                    // Update all segments based on loaded state
                    $(".segment, .dp").removeClass('on');
                    response.grid.forEach((pcb, pcbIndex) => {
                        pcb.forEach((state, segmentIndex) => {
                            if (state === 1) {
                                $(`.segment[data-pcb="${pcbIndex}"][data-segment="${segmentIndex}"], .dp[data-pcb="${pcbIndex}"][data-segment="${segmentIndex}"]`).addClass('on');
                            }
                        });
                    });
                    alert("Preset loaded successfully!");
                } else {
                    alert("Error loading preset: " + response.error);
                }
            });
        });

        $("#deletePresetBtn").click(function() {
            const name = $("#presetSelect").val();
            if (!name) {
                alert("Please select a preset");
                return;
            }

            if (confirm(`Are you sure you want to delete preset "${name}"?`)) {
                $.post('/delete_preset', { name: name }, function(response) {
                    if (response.success) {
                        updatePresetDropdown(response.presets);
                        alert("Preset deleted successfully!");
                    } else {
                        alert("Error deleting preset: " + response.error);
                    }
                });
            }
        });

        function updatePresetDropdown(presets) {
            const $select = $("#presetSelect");
            $select.empty();
            $select.append($('<option>', {
                value: '',
                text: 'Select a preset...'
            }));
            presets.forEach(preset => {
                $select.append($('<option>', {
                    value: preset,
                    text: preset
                }));
            });
        }
    </script>
</body>
</html>